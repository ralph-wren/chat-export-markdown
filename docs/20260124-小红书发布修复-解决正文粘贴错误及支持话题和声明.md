# 小红书发布功能修复说明 (2026-01-24)

## 问题描述
用户反馈在小红书发布页面，标题可以正确填充，但正文内容粘贴错误（可能为空或格式不正确）。此外，需要支持自动添加话题和内容类型声明。

## 修复思路
1. **正文填充优化**：小红书使用的是 Slate.js 富文本编辑器。直接对编辑器容器进行操作往往无效。通过 Playwright 录制发现，需要先点击编辑器内部的 `p` 标签或特定节点来激活输入状态，然后再进行粘贴。
2. **模拟粘贴增强**：改用分发 `paste` 事件的方式填充内容，这种方式对富文本编辑器更友好。同时保留了逐行插入的作为回退方案。
3. **新增功能支持**：
    - **话题自动提取与添加**：从生成的文章内容中自动提取 `#话题` 格式的内容，并在发布设置页面自动点击对应的标签。
    - **内容类型声明**：自动设置“虚构演绎，仅供娱乐”的声明，符合平台合规要求。

## 更改详情

### 1. 核心逻辑改进 ([xiaohongshu.ts](file:///c:/Users/ralph/IdeaProject/Memoraid/src/content/xiaohongshu.ts))
- **`fillContent`**：
    - 增加对编辑器内层段落的定位与点击，确保编辑器处于激活状态。
    - 优化 `paste` 事件的分发逻辑，直接作用于获得焦点的目标元素。
    - 增加粘贴后的内容检查，若失败则自动触发回退模式。
- **`addTopics`**：
    - 实现了先点击“添加话题”按钮展开列表，再匹配点击具体话题，最后关闭列表的完整流程。
- **`setContentTypeDeclaration`**：
    - 实现了自动寻找并设置内容类型声明的功能。
- **`SELECTORS`**：
    - 增加了更精准的话题和声明相关的选择器。

### 2. 后端流程优化 ([index.ts](file:///c:/Users/ralph/IdeaProject/Memoraid/src/background/index.ts))
- **话题提取**：在文章生成完成后，自动通过正则提取前 5 个话题。
- **参数传递**：更新了 `handlePublishToXiaohongshu` 的调用，将提取的话题和默认声明传递给 Content Script。

## 验证结果
- 已执行 `npm run build` 通过编译。
- 代码逻辑完全对齐用户提供的 Playwright 执行步骤。

## 后续建议
- 如果小红书 DOM 结构发生重大变化，请重新使用 `npx playwright codegen` 获取最新选择器。
- 话题提取目前基于 `#` 符号，建议在生成文章的 Prompt 中明确要求 AI 生成符合格式的话题。
