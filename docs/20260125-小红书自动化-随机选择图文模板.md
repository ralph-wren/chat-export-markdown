# 小红书自动化 - 随机选择图文模板

## 问题描述
用户需要在小红书发布预览页面，自动随机选择一个"图文模板"。现有的自动化脚本缺少针对图文模板的选择功能（已有封面模板选择，但图文模板是不同的组件）。

## 解决思路
1.  **定位模板容器**：由于无法直接获知页面 DOM 结构，采用启发式搜索策略。
    *   **策略 1**：通过查找包含 "模板" 关键词的标题元素（如 `h3`, `div`），然后向上遍历父元素，查找其附近的网格 (`grid`) 或列表 (`list`) 容器。
    *   **策略 2**：使用通用的 CSS 类名选择器（如 `div[class*="template"]`, `div[class*="card"]`）作为备选方案。
2.  **筛选有效元素**：过滤掉不可见的元素，确保只操作用户可见的模板。
3.  **随机选择**：从找到的候选模板列表中，使用 `Math.random()` 随机选择一个索引。
4.  **模拟点击**：调用已有的 `simulateClick` 工具函数触发点击事件。
5.  **导出功能**：将新函数 `selectRandomTemplate` 导出为全局变量 `memoraidXiaohongshuSelectTemplate`，以便通过 Console 或远程调试命令调用。

## 代码变更
### 文件: `src/content/xiaohongshu.ts`

新增 `selectRandomTemplate` 函数：

```typescript
/**
 * 随机选择一个图文模板
 */
const selectRandomTemplate = async (): Promise<boolean> => {
    logger.log('查找并随机选择图文模板...', 'info');

    // 1. 优先使用精确的 CSS 类名选择器 (基于用户提供的 HTML)
    let targets = Array.from(document.querySelectorAll('.template-list .template-card'));
    let visibleTargets = targets.filter(el => isElementVisible(el as HTMLElement)) as HTMLElement[];

    // 2. 如果没找到，尝试模糊匹配类名
    if (visibleTargets.length === 0) {
        logger.log('精确选择器未找到，尝试模糊匹配...', 'info');
        const candidates = Array.from(document.querySelectorAll('div[class*="template-card"], div[class*="template-item"]'));
        visibleTargets = candidates.filter(el => isElementVisible(el as HTMLElement)) as HTMLElement[];
    }

    // 3. 如果还是没找到，尝试之前的启发式搜索（通过"模板"文字定位）
    if (visibleTargets.length === 0) {
        logger.log('类名匹配未找到，尝试通过文本定位...', 'info');
        const templateHeaders = Array.from(document.querySelectorAll('div, span, h3, h4')).filter(el => 
            el.textContent?.includes('模板') && isElementVisible(el as HTMLElement)
        );

        for (const header of templateHeaders) {
            let parent = header.parentElement;
            for(let i=0; i<3 && parent; i++) {
                const grids = parent.querySelectorAll('div[class*="grid"], ul, div[class*="list"]');
                for (const grid of Array.from(grids)) {
                    const children = Array.from(grid.children).filter(c => isElementVisible(c as HTMLElement));
                    if (children.length > 3) {
                        visibleTargets = children as HTMLElement[];
                        break;
                    }
                }
                if (visibleTargets.length > 0) break;
                parent = parent.parentElement;
            }
            if (visibleTargets.length > 0) break;
        }
    }

    if (visibleTargets.length === 0) {
        logger.log('❌ 未找到图文模板列表', 'warn');
        return false;
    }

    const randomIndex = Math.floor(Math.random() * visibleTargets.length);
    const target = visibleTargets[randomIndex];
    
    // 获取模板名称用于日志
    const templateName = target.querySelector('.template-title')?.textContent || `第 ${randomIndex + 1} 个模板`;
    logger.log(`找到 ${visibleTargets.length} 个模板，随机选择: ${templateName}`, 'action');
    
    simulateClick(target);
    await new Promise(r => setTimeout(r, 1000));
    
    logger.log('✅ 已随机选择模板', 'success');
    return true;
};
```

并导出：
```typescript
(window as any).memoraidXiaohongshuSelectTemplate = selectRandomTemplate;
```

## 验证方法
1.  执行 `npm run build` 确保编译通过。
2.  在小红书发布页面打开控制台 (F12)。
3.  输入 `memoraidXiaohongshuSelectTemplate()` 并回车，观察是否随机选中了一个模板。

## 后续优化
如果获取到了具体的页面 HTML 结构，可以针对性地优化选择器，提高准确率。
