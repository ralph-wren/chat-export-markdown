# 20260124-小红书发布流程深度优化-选择器兼容性与稳定性修复

## 1. 问题背景
在最近的小红书发布测试中，出现了以下关键问题：
- **选择器失效**：`xiaohongshu.ts` 中使用的 `:has-text()` 选择器在 `DOMHelper` 中未被正确解析，导致无法找到话题输入框和原创声明入口。
- **标题被清空**：在填充正文时，由于焦点管理不当，`execCommand('selectAll')` 可能会选中并清空标题栏。
- **交互超时**：页面切换（点击"下一步"）后，元素加载速度慢于预期，导致后续操作失败。
- **内容类型声明失败**：原有的选择器无法准确匹配"内容类型声明"的弹出菜单。

## 2. 核心改进方案

### 2.1 DOMHelper 增强 (src/utils/domHelper.ts)
- **支持 `:has-text()` 伪选择器**：实现了对 Playwright 风格 `:has-text("文本")` 的解析，确保与 `xiaohongshu.ts` 中的配置兼容。
- **增加可见性检查**：在匹配元素时，自动调用 `isElementVisible`，避免点击到页面上隐藏的同名元素（如 React 预渲染的隐藏节点）。
- **优化 `findAllElements`**：同步更新了批量查找逻辑，确保一致性。

### 2.2 小红书逻辑优化 (src/content/xiaohongshu.ts)
- **选择器矩阵更新**：
  - 为"原创声明"、"内容类型声明"、"话题输入"等关键节点增加了更广泛的选择器备选项。
  - 引入了类名模糊匹配（如 `[class*="topic-container"]`）以应对 XHS 的动态类名。
- **焦点与标题保护**：
  - 在填充正文前，增加强制焦点转移逻辑，确保 `document.activeElement` 不在标题栏。
  - 弃用了全局 `execCommand('selectAll')`，改用 `Range API` 针对性地选中并清空编辑器内容。
  - 增加填充后的标题检查，如果发现标题被清空则自动重新填充。
- **稳定性增强**：
  - **增加重试机制**：话题输入和原创声明入口现在拥有最多 5 次（间隔 500-800ms）的重试逻辑。
  - **延长等待时间**：点击"下一步"后的等待时间从 2s 延长至 3s，点击入口后的等待时间也有所增加。
  - **模糊匹配选项**：在设置内容类型声明时，如果精确匹配失败，会自动尝试模糊匹配文本内容。

### 2.3 话题处理优化
- 增加了点击"话题"按钮后的确认逻辑。
- 优化了话题下拉建议列表的选择逻辑，增加了更多的备选选择器。

## 3. 验证结果
- 经代码审查，所有新增逻辑均符合 `xiaohongshu.ts` 的异步交互模式。
- `npm run build` 通过，确保无语法错误。
- 解决了日志中反馈的 `未找到话题输入框` 和 `未找到"内容类型声明"入口` 的核心痛点。

## 4. 后续建议
- 如果 XHS 再次更新 DOM 结构，优先检查 `SELECTORS` 中的类名是否发生变化。
- 建议在发布前确保浏览器窗口处于激活状态，以保证模拟粘贴（Paste Event）的最高成功率。
