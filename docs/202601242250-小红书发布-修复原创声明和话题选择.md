# 小红书发布流程修复：原创声明和话题选择

**日期**: 2026-01-24 22:50  
**问题**: 在小红书发布页面，原创声明步骤和话题选择步骤没有正确执行  
**状态**: ✅ 已修复

---

## 📋 问题描述

用户反馈在使用小红书自动发布功能时，遇到以下问题：

1. **原创声明步骤失败**：
   - 日志显示：`未找到原创声明勾选框`
   - 脚本点击了"去声明"按钮，但无法找到勾选框

2. **话题选择功能缺失**：
   - 话题选择步骤没有正确执行
   - 话题输入框和下拉建议列表的选择器不准确

---

## 🔍 问题分析

### 用户提供的调试信息

用户通过 Playwright Codegen 录制了实际的操作流程，提供了以下关键代码：

```typescript
// 话题选择
await page.getByRole('button', { name: '话题' }).click();
await page.getByRole('textbox').filter({ hasText: '#' }).click();
await page.getByRole('textbox').filter({ hasText: '#' }).fill('#奶茶');
await page.locator('#creator-editor-topic-container').getByText('#奶茶', { exact: true }).click();

// 原创声明
await page.getByText('去声明').click();
await page.locator('.d-checkbox-indicator').click();
await page.getByRole('button', { name: '声明原创' }).click();
```

### 根本原因

1. **话题输入框选择器不准确**：
   - 原代码使用：`.topic-container [contenteditable]` 等通用选择器
   - 实际应该优先查找：包含 `#` 字符的 `contenteditable` 元素
   - Playwright 使用的是 `role="textbox"` 且包含 `#` 文本

2. **话题建议列表容器不正确**：
   - 原代码使用通用选择器
   - 实际建议列表在 `#creator-editor-topic-container` 容器中

3. **原创声明等待时间不足**：
   - 弹窗加载需要更多时间
   - 缺少重试逻辑
   - 选择器 `.d-checkbox-indicator` 是正确的，但需要增加查找时间

---

## 🔧 修复方案

### 1. 优化话题输入框选择器

**修改位置**: `SELECTORS.topicInput`

```typescript
// 修复前
topicInput: [
    '.topic-container [contenteditable]',
    '.topic-input [contenteditable]',
    '[placeholder*="添加话题"]',
    '.topic-container input'
]

// 修复后
topicInput: [
    '[contenteditable][role="textbox"]',  // 优先使用 role 属性
    '[contenteditable]',  // 备用：任何 contenteditable 元素
    '.topic-container [contenteditable]',
    '.topic-input [contenteditable]',
    '[placeholder*="添加话题"]'
]
```

### 2. 改进话题选择逻辑

**修改位置**: `addTopics()` 函数

**关键改进**：

1. **动态查找包含 `#` 的输入框**：
   ```typescript
   // 先尝试找到包含 # 的 contenteditable 元素
   const editables = Array.from(document.querySelectorAll('[contenteditable="true"], [contenteditable]'));
   input = editables.find(el => {
       const text = (el as HTMLElement).textContent || '';
       return text.includes('#') && isElementVisible(el as HTMLElement);
   }) as HTMLElement || null;
   ```

2. **使用正确的建议列表容器**：
   ```typescript
   // 根据 Playwright 代码，建议列表在 #creator-editor-topic-container 中
   const container = document.querySelector('#creator-editor-topic-container');
   if (container) {
       const allElements = Array.from(container.querySelectorAll('*'));
       const suggestions = allElements.filter(el => {
           const text = el.textContent?.trim() || '';
           return text === keyword && isElementVisible(el as HTMLElement);
       });
   }
   ```

3. **添加备用方案**：
   - 如果精确匹配失败，尝试模糊匹配
   - 如果找不到容器，使用旧的选择器作为备用

### 3. 增强原创声明的稳定性

**修改位置**: `setOriginalityDeclaration()` 函数

**关键改进**：

1. **增加等待时间**：
   ```typescript
   // 点击"去声明"后，增加等待时间确保弹窗完全加载
   await new Promise(r => setTimeout(r, 2000));  // 从 1500ms 增加到 2000ms
   ```

2. **添加重试逻辑**：
   ```typescript
   // 查找勾选框时增加重试机制
   let checkbox: HTMLElement | null = null;
   for (let i = 0; i < 5; i++) {
       checkbox = findElement(SELECTORS.originalityCheckbox);
       if (checkbox) {
           logger.log('找到原创声明勾选框', 'info');
           break;
       }
       logger.log(`第 ${i + 1} 次尝试查找原创声明勾选框...`, 'info');
       await new Promise(r => setTimeout(r, 500));
   }
   ```

3. **添加备用查找逻辑**：
   ```typescript
   if (!checkbox) {
       // 尝试查找是否有其他可能的复选框元素
       const allCheckboxes = Array.from(document.querySelectorAll(
           '[class*="checkbox"], [role="checkbox"], input[type="checkbox"]'
       ));
       logger.log(`页面上共找到 ${allCheckboxes.length} 个复选框元素`, 'info');
       
       if (allCheckboxes.length > 0) {
           const visibleCheckbox = allCheckboxes.find(el => 
               isElementVisible(el as HTMLElement)
           );
           if (visibleCheckbox) {
               checkbox = visibleCheckbox as HTMLElement;
               logger.log('使用备用复选框元素', 'info');
           }
       }
   }
   ```

4. **为"声明原创"按钮也添加重试逻辑**：
   ```typescript
   // 点击"声明原创"按钮时也增加重试
   let confirmBtn: HTMLElement | null = null;
   for (let i = 0; i < 5; i++) {
       confirmBtn = findElement(SELECTORS.declareOriginalButton);
       if (confirmBtn) {
           logger.log('找到"声明原创"按钮', 'info');
           break;
       }
       logger.log(`第 ${i + 1} 次尝试查找"声明原创"按钮...`, 'info');
       await new Promise(r => setTimeout(r, 500));
   }
   ```

---

## ✅ 验证结果

1. **代码构建**: ✅ 通过，无 TypeScript 错误
2. **选择器准确性**: ✅ 基于 Playwright 录制的真实代码
3. **容错性**: ✅ 添加了重试逻辑和备用方案

---

## 📝 修改的文件

- `src/content/xiaohongshu.ts`:
  - 更新话题输入框选择器（第 86-92 行）
  - 重构 `addTopics()` 函数（第 637-756 行）
  - 增强 `setOriginalityDeclaration()` 函数（第 586-631 行）

---

## 💡 关键学习点

1. **使用 Playwright Codegen 验证选择器**：
   - 通过录制真实操作来获取准确的选择器
   - 比手动猜测 DOM 结构更可靠

2. **动态查找元素**：
   - 优先使用元素的内容特征（如包含 `#` 字符）
   - 而不是依赖可能变化的 CSS 类名

3. **增加容错性**：
   - 添加重试逻辑
   - 提供备用查找方案
   - 记录详细的调试日志

4. **等待时间的重要性**：
   - 弹窗和异步加载的内容需要足够的等待时间
   - 不同的操作需要不同的等待时长

---

## 🚀 后续建议

1. **测试验证**：
   - 在实际环境中测试修复后的流程
   - 验证不同话题数量的情况

2. **监控日志**：
   - 观察新增的调试日志输出
   - 确认重试逻辑是否有效

3. **持续优化**：
   - 如果小红书页面结构再次变化，使用相同方法（Playwright Codegen）来更新选择器
   - 考虑添加更多的调试信息，便于未来排查问题

---

## 相关文件

- 主要代码: `src/content/xiaohongshu.ts`
- 测试录制: 用户提供的 Playwright 测试代码
- 调试工具: `npx playwright codegen --channel=chrome`
