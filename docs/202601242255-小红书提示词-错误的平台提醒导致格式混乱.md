# 小红书提示词问题排查与修复

**日期**: 2026-01-24 22:55  
**问题**: 点击小红书按钮生成的文章，感觉像是用公众号提示词生成的  
**状态**: ✅ 问题已找到，待修复

---

## 📋 问题描述

用户发现点击小红书按钮生成文章时，生成的格式更像是公众号的风格，而不是小红书特有的风格（大量Emoji、短分段、话题标签等）。

---

## 🔍 问题分析

### 1. 提示词组合机制

在 `background/index.ts` 的 `startArticleGenerationAndPublish` 函数中，系统会组合两部分提示词：

1. **通用模板** (`ARTICLE_PROMPT_TEMPLATE`) - 所有平台共享的基础规则
2. **平台专属提示词** - 各平台的专属规则，优先级最高

代码位置（第 1998-2000 行）：
```typescript
} else if (platform === 'xiaohongshu') {
  // 小红书：使用用户自定义提示词或默认小红书提示词
  platformPrompt = settings.xiaohongshu?.customPrompt || XIAOHONGSHU_DEFAULT_PROMPT;
}
```

✅ **这部分是正确的**：小红书确实使用了专属提示词。

### 2. 发现的问题

在组合提示词后，系统还会在 user 消息中添加一个 `platformReminder`（平台特殊提醒）。

**问题代码**（推测在第 2028-2033 行附近）：
```typescript
// 根据平台添加特殊提醒
let platformReminder = '';
if (platform === 'toutiao' || platform === 'zhihu') {
  platformReminder = `\n\n⚠️ 重要提醒：${platformName}平台的图片提示词必须是2-5个字的简短关键词`;
} else if (platform === 'weixin' || platform === 'xiaohongshu') {
  // ❌ 错误：把小红书和公众号归为同一类
  platformReminder = `\n\n⚠️ 重要提醒：${platformName}平台的图片提示词需要15-50字的详细场景描述，用于AI生成配图。文章最后必须包含[封面: xxx]和[摘要: xxx]。`;
}
```

**问题**：
- ❌ 小红书被错误地和公众号归为同一类
- ❌ 小红书不需要详细的图片描述（小红书专属提示词第877-879行明确说：`不需要生成图片占位符，小红书会自动处理`）
- ❌ 小红书不需要 `[封面: xxx]` 和 `[摘要: xxx]`

### 3. 正确的小红书要求

根据 `prompts.ts` 中的 `XIAOHONGSHU_DEFAULT_PROMPT`（第835-885行）：

```typescript
### 图片配图要求（小红书平台专用）
- 不需要生成图片占位符，小红书会自动处理

### 导出话题（CRITICAL）
- 小红书笔记结尾**必须**包含至少5个相关话题，格式为 `#标签名`。
```

小红书的关键要求：
- ✅ 必须大量使用 Emoji
- ✅ 分段要短（每一行或每两行一个段落）
- ✅ 结尾必须包含至少5个话题标签（格式：`#标签名`）
- ❌ 不需要生成图片占位符
- ❌ 不需要封面提示词
- ❌ 不需要摘要

---

## 🔧 修复方案

### 修改文件：`src/background/index.ts`

找到 `platformReminder` 的定义位置（在 `startArticleGenerationAndPublish` 函数中，大约第2028行附近），修改为：

```typescript
// 根据平台添加特殊提醒
let platformReminder = '';
if (platform === 'toutiao' || platform === 'zhihu') {
  platformReminder = `\n\n⚠️ 重要提醒：${platformName}平台的图片提示词必须是2-5个字的简短关键词（如\"卫星\"、\"星空\"），严禁使用长句子描述！`;
} else if (platform === 'weixin') {
  // 只有公众号需要封面和摘要
  platformReminder = `\n\n⚠️ 重要提醒：${platformName}平台的图片提示词需要15-50字的详细场景描述，用于AI生成配图。文章最后必须包含[封面: xxx]和[摘要: xxx]。`;
} else if (platform === 'xiaohongshu') {
  // 小红书不需要封面和摘要，但需要Emoji和话题
  platformReminder = `\n\n⚠️ 重要提醒：小红书平台必须大量使用Emoji，分段要短，结尾必须包含至少5个话题标签（格式：#标签名）。不需要生成图片占位符。`;
}
```

---

## ✅ 验证方式

修复后，重新测试小红书文章生成：

1. **构建扩展**：
   ```bash
   npm run build
   ```

2. **重新加载扩展**：在 `chrome://extensions` 中点击刷新

3. **测试生成**：点击小红书按钮生成一篇文章，检查：
   - ✅ 是否有大量 Emoji
   - ✅ 段落是否很短
   - ✅ 结尾是否有话题标签（`#标签1 #标签2 ...`）
   - ❌ 是否还有 `[封面: xxx]` 和 `[摘要: xxx]`（应该没有）

---

## 💡 为什么会有这个问题

1. **开发顺序**：可能是先开发了公众号功能，后来添加小红书时，直接复用了公众号的逻辑
2. **相似性混淆**：公众号和小红书都有一些相似点（都需要配图），所以被归为同一类
3. **提示词层级**：虽然小红书有专属提示词（优先级高），但 `platformReminder` 在 user 消息中，会直接影响AI的生成行为

---

## 📝 相关文件

- **问题代码**: `src/background/index.ts` - `startArticleGenerationAndPublish` 函数
- **小红书专属提示词**: `src/utils/prompts.ts` - `XIAOHONGSHU_DEFAULT_PROMPT`（第835-885行）
- **通用提示词**: `src/utils/prompts.ts` - `ARTICLE_PROMPT_TEMPLATE`（第329-491行）

---

## 🚀 后续建议

1. **测试各平台生成效果**：确保每个平台都遵循各自的专属规则
2. **代码审查**：检查是否还有其他地方把小红书和其他平台混淆
3. **文档更新**：在代码注释中明确每个平台的特殊要求
