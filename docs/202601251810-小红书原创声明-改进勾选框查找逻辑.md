# 小红书原创声明 - 改进勾选框查找逻辑

## 问题描述
在小红书自动发布流程中，点击"去声明"后无法找到原创声明的勾选框，导致原创声明设置失败。

从日志中可以看到：
```
[18:08:03] ▶️ 点击"去声明"
[18:08:05] ℹ️ 第 1 次尝试查找原创声明勾选框...
...
[18:08:07] ⚠️ 未找到原创声明勾选框
[18:08:07] ℹ️ 页面上共找到 2 个复选框元素
```

虽然页面上存在2个复选框元素，但原有逻辑无法准确识别哪个是原创声明的复选框。

## 问题原因
1. **选择器不够精确**：原有的选择器 `[class*="checkbox"]` 太宽泛，可能匹配到其他无关的复选框
2. **缺少智能判断**：直接使用第一个可见的复选框，没有判断该复选框是否与"原创声明"相关
3. **调试信息不足**：无法知道找到的复选框对应的是什么功能

## 解决方案
改进了 `setOriginalityDeclaration` 函数中的备用复选框查找逻辑：

### 修改前
```typescript
if (allCheckboxes.length > 0) {
    const visibleCheckbox = allCheckboxes.find(el => isElementVisible(el as HTMLElement));
    if (visibleCheckbox) {
        checkbox = visibleCheckbox as HTMLElement;
        logger.log('使用备用复选框元素', 'info');
    }
}
```

### 修改后
```typescript
if (allCheckboxes.length > 0) {
    // 优先查找与"原创"相关的复选框（通过父元素或兄弟元素的文本内容判断）
    const originalCheckbox = allCheckboxes.find(el => {
        const parent = el.parentElement;
        const grandParent = parent?.parentElement;
        const text = (parent?.textContent || '') + (grandParent?.textContent || '');
        return text.includes('原创') && isElementVisible(el as HTMLElement);
    });

    if (originalCheckbox) {
        checkbox = originalCheckbox as HTMLElement;
        logger.log('找到与"原创"相关的复选框', 'info');
    } else {
        // 如果没找到与"原创"相关的，查找第一个可见的复选框
        const visibleCheckbox = allCheckboxes.find(el => isElementVisible(el as HTMLElement));
        if (visibleCheckbox) {
            checkbox = visibleCheckbox as HTMLElement;
            logger.log('使用第一个可见的复选框', 'info');
            // 输出该复选框的信息以便调试
            const parent = visibleCheckbox.parentElement;
            logger.log(`复选框父元素文本: ${parent?.textContent?.substring(0, 50)}`, 'info');
        }
    }
}
```

## 改进要点

### 0. 优化原创声明入口按钮选择器 ⭐
根据实际页面结构，添加了更精确的选择器：
```typescript
originalityEntry: [
    '.media-settings .wrapper.red span.btn-text.red',  // 最精确的选择器
    '.media-settings span.btn-text.red',  // 稍微宽松一点
    '.wrapper.red span.btn-text',  // 红色按钮文本
    'span.btn-text.red',  // 红色按钮文本（更宽松）
    // ... 原有的选择器作为备用
]
```

**选择器来源**：
- 根据页面实际结构：`#web > div > div > div > div > div.body > div.content > div.media-settings > div > div:nth-child(1) > div > div > div:nth-child(1) > div.wrapper.red > span:nth-child(1) > span.btn-text.red`
- 提取关键类名：`.media-settings`、`.wrapper.red`、`span.btn-text.red`
- 构建从精确到宽松的选择器梯度

### 0.1. 优化原创声明勾选框选择器 ⭐
根据实际弹窗结构，添加了更精确的选择器：
```typescript
originalityCheckbox: [
    '.originalContainer .footer span.d-checkbox-simulator',  // 最精确
    '.originalContainer span.d-checkbox-simulator',  // 稍微宽松
    'span.d-checkbox-simulator',  // 复选框模拟器
    // ... 原有的选择器作为备用
]
```

**选择器来源**：
- 勾选框结构：`body > div:nth-child(23) > div.originalContainer > div.footer > div > div > span.d-checkbox-simulator.--color-bg-white.unchecked > span`
- 提取关键类名：`.originalContainer`、`.footer`、`span.d-checkbox-simulator`

### 0.2. 优化声明原创按钮选择器 ⭐
根据实际弹窗结构，添加了更精确的选择器：
```typescript
declareOriginalButton: [
    '.originalContainer .footer button',  // 最精确
    '.originalContainer button',  // 稍微宽松
    // ... 原有的选择器作为备用
]
```

**选择器来源**：
- 按钮结构：`body > div:nth-child(23) > div.originalContainer > div.footer > button > div > span`
- 提取关键类名：`.originalContainer`、`.footer`、`button`

### 1. 智能匹配
- 检查复选框的父元素和祖父元素的文本内容
- 优先选择包含"原创"关键词的复选框
- 确保选中的是与原创声明相关的控件

### 2. 降级策略
- 如果找不到与"原创"相关的复选框，才使用第一个可见的复选框
- 这样可以在页面结构变化时仍有一定的容错能力

### 3. 增强调试
- 输出找到的复选框的父元素文本
- 方便后续排查问题时了解选中了哪个元素
- 增加了更明确的日志信息

## 修改文件
- `src/content/xiaohongshu.ts` 
  - 第105-118行：原创声明入口按钮选择器优化
  - 第120-131行：原创声明勾选框选择器优化
  - 第128-137行：声明原创按钮选择器优化
  - 第628-655行：原创声明勾选框查找逻辑改进（智能匹配）

## 验证结果
- ✅ 代码逻辑更智能
- ✅ 构建成功 (`npm run build`)
- ✅ 增加了调试信息

## 预期效果
1. 更准确地找到原创声明的复选框
2. 即使页面结构有变化，也能通过关键词匹配找到正确的元素
3. 通过详细的日志输出，便于后续问题排查

## 注意事项
- 请重新加载扩展后测试
- 如果仍然无法找到勾选框，请查看日志中的"复选框父元素文本"信息
- 可能需要根据实际页面结构进一步调整选择器

## 相关代码位置
- **文件**: `src/content/xiaohongshu.ts`
- **函数**: `setOriginalityDeclaration`
- **行号**: 622-655
