# 提示词优先级机制实现

**日期**: 2026-01-24  
**功能**: 提示词优先级  
**问题**: 确保各平台专属提示词规则在与通用提示词冲突时优先生效  

## 一、需求背景

用户要求：当各个平台的提示词规则和通用提示词规则有冲突时，要求优先使用各平台专属提示词。

## 二、问题分析

在 Memoraid 项目中，提示词分为两类：
1. **通用提示词** (`ARTICLE_PROMPT_TEMPLATE`): 包含所有平台共享的基本写作规则
2. **平台专属提示词**: 
   - `TOUTIAO_DEFAULT_PROMPT` (头条专属)
   - `WEIXIN_DEFAULT_PROMPT` (公众号专属)
   - `ZHIHU_DEFAULT_PROMPT` (知乎专属)

在 `src/background/index.ts` 的 `startArticleGenerationAndPublish` 函数中，提示词组合方式为：

```typescript
// 组合完整提示词：通用模板 + 平台专属指南
const fullPrompt = `${articlePrompt}\n\n${platformPrompt}`;
```

由于平台专属提示词在**后面**，根据 AI 模型处理提示词的特性，后面的指令会覆盖前面的指令，因此理论上已经实现了优先级。

## 三、解决方案

为了让优先级机制更加**明确和可靠**，我们采取了以下改进措施：

### 3.1 在通用提示词开头添加优先级说明

在 `ARTICLE_PROMPT_TEMPLATE` 的开头添加：

```markdown
## ⚠️ 重要说明：提示词优先级
**本提示词为通用模板，如果后续有平台专属提示词，且两者存在冲突时，必须优先遵循平台专属提示词的规则。**
```

### 3.2 在各平台专属提示词开头强调优先级

在每个平台专属提示词的开头添加醒目的优先级声明：

**头条号**:
```markdown
## 🔥 头条号平台专属规则（优先级最高）
**重要：以下头条专属规则与通用提示词冲突时，必须优先遵循头条专属规则！**
```

**微信公众号**:
```markdown
## 🔥 微信公众号平台专属规则（优先级最高）
**重要：以下公众号专属规则与通用提示词冲突时，必须优先遵循公众号专属规则！**
```

**知乎**:
```markdown
## 🔥 知乎平台专属规则（优先级最高）
**重要：以下知乎专属规则与通用提示词冲突时，必须优先遵循知乎专属规则！**
```

### 3.3 添加明确的分隔标记（重要改进！）

在组合提示词时，添加了**醒目的分隔线和标注**，让 AI 能清楚识别哪部分是通用规则，哪部分是平台专属规则：

```typescript
const fullPrompt = `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📋 【第一部分：通用文章生成规则】
以下是所有平台共享的基础写作规则。
如果与后续的平台专属规则有冲突，请优先遵循平台专属规则。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${articlePrompt}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 【第二部分：${platformName}平台专属规则】
以下是${platformName}平台的专属规则，优先级最高！
当与上述通用规则冲突时，必须严格遵循本部分的规则。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${platformPrompt}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ 【优先级提醒】
如果通用规则和${platformName}专属规则有任何冲突，请无条件遵循${platformName}专属规则！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
`;
```

**改进原理**：
- 使用 **━** 符号创建醒目的分隔线
- 使用 📋 🎯 ⚠️ emoji 增强视觉识别度
- 使用 **【方括号】** 标注每部分的作用
- 在开头和结尾都明确说明优先级规则
- 重复强调"无条件遵循"，增加 AI 的理解权重

### 3.4 更新提示词版本号

按照项目规则，修改提示词后需要更新版本号，从 `1.0.0` 升级到 `1.1.0`：

```typescript
export const PROMPT_VERSIONS = {
  TOUTIAO: '1.1.0',  // 添加了优先级说明
  ZHIHU: '1.1.0',    // 添加了优先级说明
  WEIXIN: '1.1.0'    // 添加了优先级说明
};
```

## 四、实现细节

### 修改文件
- `src/utils/prompts.ts` - 提示词模板定义
- `src/background/index.ts` - 提示词组合逻辑

### 修改内容

**prompts.ts**:
1. 在第 331 行添加通用提示词优先级说明（第329行后插入3行）
2. 在第 493 行添加头条专属优先级声明（第490行后插入3行）
3. 在第 561 行添加公众号专属优先级声明（第558行后插入3行）
4. 在第 662 行添加知乎专属优先级声明（第659行后插入3行）
5. 在第 832-834 行更新版本号为 1.1.0

**background/index.ts**:
6. 在第 1914-1937 行修改提示词组合逻辑，添加明确的分隔标记和标注

## 五、工作原理

### 5.1 提示词组合流程

```
用户发起生成文章请求
    ↓
根据用户设置生成通用提示词 (articlePrompt)
    ↓
根据目标平台获取专属提示词 (platformPrompt)
    ↓
组合完整提示词: fullPrompt = articlePrompt + "\n\n" + platformPrompt
    ↓
发送给 AI 模型生成文章
```

### 5.2 优先级保证机制

1. **位置优先**: 平台专属提示词在通用提示词**之后**，根据 AI 模型的处理特性，后面的指令会覆盖前面冲突的指令
2. **明确声明**: 在提示词中**明确告知** AI 模型优先级规则，让 AI 主动识别并处理冲突
3. **醒目标记**: 使用 🔥 emoji 和加粗文字，让 AI 模型更容易注意到优先级指令

### 5.3 冲突示例

**示例1: 标题字数限制**

- 通用提示词规定: "标题默认控制在28个字以内"
- 公众号专属提示词规定: "标题最多64字（平台限制）"
- **结果**: AI 会采用公众号的64字限制

**示例2: 图片描述格式**

- 通用提示词规定: "图片占位符格式：[图片: 描述]"
- 头条专属提示词规定: "关键词要求：必须是2-5个字的简短名词"
- 公众号专属提示词规定: "描述要详细具体（15-50字）"
- **结果**: 根据目标平台，AI 会使用对应的图片描述格式

**示例3: 格式限制**

- 通用提示词允许: 使用加粗、下划线等格式
- 知乎专属提示词规定: "严禁使用 Markdown 加粗、下划线"
- **结果**: 知乎文章不会使用任何格式标记

## 六、验证测试

### 构建验证
执行 `npm run build` 验证代码无错误：
```
✓ 5479 modules transformed.
✓ built in 8.85s
Exit code: 0
```

### 功能验证建议
1. 生成头条文章，检查图片描述是否为短关键词（2-5字）
2. 生成公众号文章，检查是否有封面和摘要、图片描述是否详细（15-50字）
3. 生成知乎文章，检查是否没有使用加粗/下划线等格式

## 七、后续维护

### 7.1 添加新平台

如果要添加新平台的专属提示词，需要：
1. 创建新的平台专属提示词常量（参考现有格式）
2. 在开头添加优先级声明
3. 在 `PROMPT_VERSIONS` 中添加版本号
4. 在 `startArticleGenerationAndPublish` 函数中添加对应逻辑

### 7.2 修改提示词规则

修改任何提示词时：
1. **必须**考虑是否会与其他提示词冲突
2. 如果修改的是通用提示词，检查各平台是否有覆盖规则
3. 如果修改的是平台专属提示词，确保优先级声明仍然存在
4. **必须**更新对应的版本号（遵循 rules.md 规则4）

### 7.3 版本号管理

遵循语义化版本控制 (Semantic Versioning):
- **主版本号** (X.0.0): 重大架构调整或完全重写
- **次版本号** (1.X.0): 添加新功能或重要改进（如本次添加优先级机制）
- **修订号** (1.1.X): Bug 修复或小幅调整

## 八、技术要点总结

1. **提示词工程**: 利用 AI 模型对后续指令的更高权重特性
2. **明确性原则**: 通过显式声明让 AI 理解优先级规则
3. **视觉突出**: 使用 emoji 和加粗提高 AI 的注意力权重
4. **版本控制**: 严格遵循项目规则进行版本号管理
5. **文档先行**: 每次修改都记录详细的技术文档

## 九、参考资料

- 相关代码文件: `src/utils/prompts.ts`, `src/background/index.ts`
- 相关规则: `MEMORY[rules.md]` 规则4（提示词版本号管理）
- 相关对话: Conversation ID 7af67df1 (Refresh Prompt Settings)
