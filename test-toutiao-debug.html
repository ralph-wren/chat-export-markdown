<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤´æ¡è‡ªåŠ¨å¡«å……è°ƒè¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #1890ff;
    }
    .section h2 {
      margin-top: 0;
      color: #1890ff;
      font-size: 18px;
    }
    button {
      background: #1890ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #40a9ff;
    }
    button.secondary {
      background: #52c41a;
    }
    button.secondary:hover {
      background: #73d13d;
    }
    button.danger {
      background: #ff4d4f;
    }
    button.danger:hover {
      background: #ff7875;
    }
    .info {
      background: #e6f7ff;
      border: 1px solid #91d5ff;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
    }
    .success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }
    .error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }
    .warning {
      background: #fffbe6;
      border: 1px solid #ffe58f;
      color: #faad14;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    .log {
      max-height: 300px;
      overflow-y: auto;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    .log-entry {
      margin-bottom: 5px;
    }
    .log-time {
      color: #858585;
    }
    .log-info { color: #4fc3f7; }
    .log-success { color: #66bb6a; }
    .log-error { color: #ef5350; }
    .log-warn { color: #ffa726; }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 100px;
      font-family: inherit;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #666;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ å¤´æ¡è‡ªåŠ¨å¡«å……è°ƒè¯•å·¥å…·</h1>
    <p class="subtitle">ç”¨äºæµ‹è¯•å’Œè°ƒè¯•å¤´æ¡å·è‡ªåŠ¨å¡«å……åŠŸèƒ½</p>

    <!-- æ­¥éª¤1: æ£€æŸ¥æ‰©å±•çŠ¶æ€ -->
    <div class="section">
      <h2>æ­¥éª¤ 1: æ£€æŸ¥æ‰©å±•çŠ¶æ€</h2>
      <button onclick="checkExtension()">æ£€æŸ¥æ‰©å±•æ˜¯å¦åŠ è½½</button>
      <button onclick="checkStorage()" class="secondary">æ£€æŸ¥ Storage æ•°æ®</button>
      <div id="extensionStatus"></div>
    </div>

    <!-- æ­¥éª¤2: è®¾ç½®æµ‹è¯•æ•°æ® -->
    <div class="section">
      <h2>æ­¥éª¤ 2: è®¾ç½®æµ‹è¯•æ•°æ®</h2>
      <label>æ–‡ç« æ ‡é¢˜ï¼š</label>
      <input type="text" id="testTitle" value="æµ‹è¯•æ–‡ç« æ ‡é¢˜ - è‡ªåŠ¨å¡«å……æµ‹è¯•" />
      
      <label>æ–‡ç« å†…å®¹ï¼š</label>
      <textarea id="testContent">è¿™æ˜¯ä¸€ç¯‡æµ‹è¯•æ–‡ç« çš„å†…å®¹ã€‚

[å›¾ç‰‡: é£æ™¯]

è¿™é‡Œæ˜¯ç¬¬äºŒæ®µå†…å®¹ï¼Œç”¨äºæµ‹è¯•è‡ªåŠ¨å¡«å……åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

[å›¾ç‰‡: ç¾é£Ÿ]

æ–‡ç« ç»“æŸã€‚</textarea>
      
      <label>æ¥æºå›¾ç‰‡ URLï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œå¯é€‰ï¼‰ï¼š</label>
      <textarea id="testImages" placeholder="https://example.com/image1.jpg
https://example.com/image2.jpg"></textarea>
      
      <button onclick="setTestData()">è®¾ç½®æµ‹è¯•æ•°æ®åˆ° Storage</button>
      <button onclick="clearStorage()" class="danger">æ¸…é™¤ Storage æ•°æ®</button>
      <div id="setDataStatus"></div>
    </div>

    <!-- æ­¥éª¤3: æ‰“å¼€å¤´æ¡å‘å¸ƒé¡µ -->
    <div class="section">
      <h2>æ­¥éª¤ 3: æ‰“å¼€å¤´æ¡å‘å¸ƒé¡µ</h2>
      <button onclick="openToutiao()">æ‰“å¼€å¤´æ¡å·å‘å¸ƒé¡µé¢</button>
      <div class="info">
        <strong>æç¤ºï¼š</strong>ç‚¹å‡»åä¼šåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å¤´æ¡å·å‘å¸ƒé¡µé¢ã€‚<br>
        å¦‚æœå·²è®¾ç½®æµ‹è¯•æ•°æ®ï¼Œé¡µé¢åŠ è½½ååº”è¯¥è‡ªåŠ¨å¡«å……æ ‡é¢˜å’Œå†…å®¹ã€‚
      </div>
    </div>

    <!-- æ­¥éª¤4: æŸ¥çœ‹æ—¥å¿— -->
    <div class="section">
      <h2>æ­¥éª¤ 4: æŸ¥çœ‹è°ƒè¯•æ—¥å¿—</h2>
      <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
      <div id="log" class="log"></div>
    </div>

    <!-- å¸¸è§é—®é¢˜ -->
    <div class="section">
      <h2>â“ å¸¸è§é—®é¢˜æ’æŸ¥</h2>
      <div class="info">
        <strong>å¦‚æœæ‚¬æµ®çª—æ²¡æœ‰å‡ºç°ï¼š</strong>
        <ol style="margin: 10px 0; padding-left: 20px;">
          <li>ç¡®è®¤æ‰©å±•å·²æ­£ç¡®åŠ è½½ï¼ˆæ­¥éª¤1ï¼‰</li>
          <li>ç¡®è®¤ Storage ä¸­æœ‰å¾…å‘å¸ƒæ•°æ®ï¼ˆæ­¥éª¤1ï¼‰</li>
          <li>ç¡®è®¤åœ¨å¤´æ¡å·å‘å¸ƒé¡µé¢ï¼ˆmp.toutiao.comï¼‰</li>
          <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯</li>
          <li>åœ¨æ§åˆ¶å°è¾“å…¥ <code>memoraidDebugElements()</code> æŸ¥çœ‹é¡µé¢å…ƒç´ </li>
        </ol>
        
        <strong>å¦‚æœæ²¡æœ‰è‡ªåŠ¨å¡«å……ï¼š</strong>
        <ol style="margin: 10px 0; padding-left: 20px;">
          <li>æ£€æŸ¥ Storage æ•°æ®çš„æ—¶é—´æˆ³æ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰</li>
          <li>åˆ·æ–°å¤´æ¡å‘å¸ƒé¡µé¢</li>
          <li>é‡æ–°è®¾ç½®æµ‹è¯•æ•°æ®åå†æ‰“å¼€</li>
        </ol>
      </div>
    </div>
  </div>

  <script>
    const log = (message, type = 'info') => {
      const logDiv = document.getElementById('log');
      const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
      const colors = {
        info: 'log-info',
        success: 'log-success',
        error: 'log-error',
        warn: 'log-warn'
      };
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${colors[type]}">${message}</span>`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    };

    const clearLog = () => {
      document.getElementById('log').innerHTML = '';
      log('æ—¥å¿—å·²æ¸…é™¤');
    };

    const showStatus = (elementId, message, type = 'info') => {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="info ${type}" style="margin-top: 15px;">${message}</div>`;
    };

    const checkExtension = async () => {
      log('æ£€æŸ¥æ‰©å±•çŠ¶æ€...', 'info');
      try {
        if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {
          log('âœ… Chrome æ‰©å±• API å¯ç”¨', 'success');
          log(`æ‰©å±• ID: ${chrome.runtime.id}`, 'info');
          showStatus('extensionStatus', 'âœ… æ‰©å±•å·²æ­£ç¡®åŠ è½½', 'success');
        } else {
          log('âŒ Chrome æ‰©å±• API ä¸å¯ç”¨', 'error');
          showStatus('extensionStatus', 'âŒ æ‰©å±•æœªåŠ è½½æˆ–ä¸åœ¨æ‰©å±•ç¯å¢ƒä¸­', 'error');
        }
      } catch (error) {
        log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        showStatus('extensionStatus', `âŒ é”™è¯¯: ${error.message}`, 'error');
      }
    };

    const checkStorage = async () => {
      log('æ£€æŸ¥ Storage æ•°æ®...', 'info');
      try {
        const data = await chrome.storage.local.get('pending_toutiao_publish');
        if (data && data.pending_toutiao_publish) {
          const payload = data.pending_toutiao_publish;
          const age = Date.now() - payload.timestamp;
          const ageMinutes = Math.floor(age / 60000);
          const isExpired = age > 5 * 60 * 1000;
          
          log('âœ… æ‰¾åˆ°å¾…å‘å¸ƒæ•°æ®', 'success');
          log(`æ ‡é¢˜: ${payload.title}`, 'info');
          log(`å†…å®¹é•¿åº¦: ${payload.content.length} å­—ç¬¦`, 'info');
          log(`æ¥æºå›¾ç‰‡: ${payload.sourceImages?.length || 0} å¼ `, 'info');
          log(`æ•°æ®å¹´é¾„: ${ageMinutes} åˆ†é’Ÿ ${isExpired ? '(å·²è¿‡æœŸ)' : '(æœ‰æ•ˆ)'}`, isExpired ? 'warn' : 'success');
          
          showStatus('extensionStatus', `
            <strong>âœ… Storage æ•°æ®å­˜åœ¨</strong><br>
            æ ‡é¢˜: ${payload.title}<br>
            å†…å®¹: ${payload.content.substring(0, 50)}...<br>
            æ¥æºå›¾ç‰‡: ${payload.sourceImages?.length || 0} å¼ <br>
            æ•°æ®å¹´é¾„: ${ageMinutes} åˆ†é’Ÿ ${isExpired ? '<span style="color: #ff4d4f;">(å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°è®¾ç½®)</span>' : '<span style="color: #52c41a;">(æœ‰æ•ˆ)</span>'}
          `, isExpired ? 'warning' : 'success');
        } else {
          log('âš ï¸ æœªæ‰¾åˆ°å¾…å‘å¸ƒæ•°æ®', 'warn');
          showStatus('extensionStatus', 'âš ï¸ Storage ä¸­æ²¡æœ‰å¾…å‘å¸ƒæ•°æ®ï¼Œè¯·å…ˆè®¾ç½®æµ‹è¯•æ•°æ®', 'warning');
        }
      } catch (error) {
        log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        showStatus('extensionStatus', `âŒ é”™è¯¯: ${error.message}`, 'error');
      }
    };

    const setTestData = async () => {
      log('è®¾ç½®æµ‹è¯•æ•°æ®...', 'info');
      try {
        const title = document.getElementById('testTitle').value;
        const content = document.getElementById('testContent').value;
        const imagesText = document.getElementById('testImages').value;
        const sourceImages = imagesText.split('\n').map(s => s.trim()).filter(s => s.length > 0);

        const payload = {
          title: title,
          content: content,
          htmlContent: content.replace(/\n/g, '<br>'),
          sourceUrl: 'https://example.com/test-article',
          sourceImages: sourceImages,
          timestamp: Date.now()
        };

        await chrome.storage.local.set({ pending_toutiao_publish: payload });
        
        log('âœ… æµ‹è¯•æ•°æ®å·²è®¾ç½®', 'success');
        log(`æ ‡é¢˜: ${title}`, 'info');
        log(`å†…å®¹é•¿åº¦: ${content.length} å­—ç¬¦`, 'info');
        log(`æ¥æºå›¾ç‰‡: ${sourceImages.length} å¼ `, 'info');
        
        showStatus('setDataStatus', `
          <strong>âœ… æµ‹è¯•æ•°æ®å·²æˆåŠŸè®¾ç½®åˆ° Storage</strong><br>
          ç°åœ¨å¯ä»¥æ‰“å¼€å¤´æ¡å‘å¸ƒé¡µé¢è¿›è¡Œæµ‹è¯•äº†ã€‚
        `, 'success');
      } catch (error) {
        log(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
        showStatus('setDataStatus', `âŒ é”™è¯¯: ${error.message}`, 'error');
      }
    };

    const clearStorage = async () => {
      log('æ¸…é™¤ Storage æ•°æ®...', 'info');
      try {
        await chrome.storage.local.remove('pending_toutiao_publish');
        log('âœ… Storage æ•°æ®å·²æ¸…é™¤', 'success');
        showStatus('setDataStatus', 'âœ… Storage æ•°æ®å·²æ¸…é™¤', 'success');
      } catch (error) {
        log(`âŒ æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
        showStatus('setDataStatus', `âŒ é”™è¯¯: ${error.message}`, 'error');
      }
    };

    const openToutiao = () => {
      log('æ‰“å¼€å¤´æ¡å·å‘å¸ƒé¡µé¢...', 'info');
      const url = 'https://mp.toutiao.com/profile_v4/graphic/publish';
      window.open(url, '_blank');
      log('âœ… å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€', 'success');
      log('â³ è¯·ç­‰å¾…é¡µé¢åŠ è½½ï¼Œè§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨å¡«å……', 'info');
    };

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      log('ğŸš€ è°ƒè¯•å·¥å…·å·²åŠ è½½', 'success');
      log('è¯·æŒ‰ç…§æ­¥éª¤è¿›è¡Œè°ƒè¯•', 'info');
    });
  </script>
</body>
</html>
